# This is a workflow to compile the cdeps source without cime
name: cimebuild
# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on: push

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build-cdeps-with-cime:
    runs-on: ubuntu-latest
    env:
      CC: mpicc
      FC: mpifort
      CXX: mpicxx
      CPPFLAGS: "-I/usr/include -I/usr/local/include"
      # Versions of all dependencies can be updated here
      ESMF_VERSION: ESMF_8_1_0_beta_snapshot_25
      PNETCDF_VERSION: pnetcdf-1.12.1
      NETCDF_FORTRAN_VERSION: v4.5.3
      NETCDF_C_VERSION: netcdf-c-4.7.4
    steps:
      - uses: actions/checkout@v2
      - id: load-env
        run: sudo apt-get install gfortran wget openmpi-bin libopenmpi-dev libxml2-utils
      # Build or retreve from cache the ESMF library
      - id: cache-esmf
        uses: actions/cache@v2
        with:
          path: ~/ESMF
          key: ${{ runner.os }}-${{ env.ESMF_VERSION }}-ESMF
      - id: build-ESMF
        if: steps.cache-esmf.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/esmf-org/esmf/archive/${{ env.ESMF_VERSION }}.tar.gz
          tar -xzvf ${{ env.ESMF_VERSION }}.tar.gz
          pushd esmf-${{ env.ESMF_VERSION }}
          export ESMF_DIR=`pwd`
          export ESMF_COMM=openmpi
          export ESMF_YAMLCPP="internal"
          export ESMF_INSTALL_PREFIX=$HOME/ESMF
          export ESMF_BOPT=g
          make
          make install
          popd
      # Build or retreve the pnetcdf library
      - id: cache-pnetcdf
        uses: actions/cache@v2
        with:
          path: ~/pnetcdf
          key: ${{ runner.os }}-${{ env.PNETCDF_VERSION}}-pnetcdf
      - name: pnetcdf build
        if: steps.cache-pnetcdf.outputs.cache-hit != 'true'
        run: |
          wget https://parallel-netcdf.github.io/Release/${{ env.PNETCDF_VERSION }}.tar.gz
          tar -xzvf ${{ env.PNETCDF_VERSION }}.tar.gz
          ls -l
          pushd ${{ env.PNETCDF_VERSION }}
          ./configure --prefix=$HOME/pnetcdf --enable-shared --disable-cxx
          make
          make install
          popd
      # Build or retreve the netcdf-fortran library, we use ubuntu for netcdf-c
      - name: Cache netcdf
        id: cache-netcdf
        uses: actions/cache@v2
        with:
          path: ~/netcdf
          key: ${{ runner.os }}-${{ env.NETCDF_C_VERSION }}-netcdf
      - name: netcdf c build
        if: steps.cache-netcdf.outputs.cache-hit != 'true'
        run: |
          wget https://www.unidata.ucar.edu/downloads/netcdf/ftp/${{ env.NETCDF_C_VERSION }}.tar.gz
          tar -xzvf ${{ env.NETCDF_C_VERSION }}.tar.gz
          pushd ${{ env.NETCDF_C_VERSION }}
          ./configure --prefix=$HOME/netcdf --disable-dap --disable-utilities --disable-netcdf-4
          make
          make install
          popd
      - name: Cache netcdf-fortran
        id: cache-netcdf-fortran
        uses: actions/cache@v2
        with:
          path: ~/netcdf-fortran
          key: ${{ runner.os }}-${{ env.NETCDF_FORTRAN_VERSION }}-netcdf-fortran
      - name: netcdf fortran build
        if: steps.cache-netcdf-fortran.outputs.cache-hit != 'true'
        run: |
          wget https://github.com/Unidata/netcdf-fortran/archive/${{ env.NETCDF_FORTRAN_VERSION }}.tar.gz
          tar -xzvf ${{ env.NETCDF_FORTRAN_VERSION }}.tar.gz
          pushd netcdf-fortran-*
          ./configure --prefix=$HOME/netcdf CPPFLAGS="-I$HOME/netcdf/include " LDFLAGS=\"`$HOME/netcdf/bin/nc-config --libs`\"
          make
          make install
      # Retreve or create the inputdata directory
      - name: Cache inputdata
        id: cache-inputdata
        uses: actions/cache@v2
        with:
          path: ~/inputdata
          key: cesm-inputdata
      - name: create inputdata dir
        if: steps.cache-inputdata.outputs.cache-hit != 'true'
        run: mkdir $HOME/inputdata
      - name: Checkout cime
        run: |
          cd $HOME
          git clone https://github.com/jedwards4b/cime.git -b add_github_action
          cd $HOME/cime/src/components
          ln -fs $HOME/work/CDEPS/CDEPS cdeps
          cd cdeps
          git submodule init
          git submodule update
          cd $HOME/cime/src/drivers
          git clone https://github.com/ESCOMP/CMEPS.git nuopc
      - name: Cache cprnc
        id: cache-cprnc
        uses: actions/cache@v2
        with:
          path: $HOME/cime/tools/cprnc/cprnc
          key: cprnc
      - name: Build cprnc
        if: steps.cache-cprnc.outputs.cache-hit != 'true'
        run: |
          cd $HOME/cime/tools/cprnc
          export CIME_MODEL=cesm
          ../configure --mpilib mpi-serial --machine ubuntu --macros-format Makefile
          make FC=gfortran NETCDF_PATH=$HOME/netcdf-fortran
      - name: Build tests
        run: |
          cd $HOME/cime/scripts
          mkdir $HOME/scratch
          export CIME_MODEL=cesm
          export CC=mpicc
          export FC=mpif90
          export NETCDF_PATH=/usr
          export NETCDF_FORTRAN_PATH=$HOME/netcdf-fortran
          export NETCDF_C_PATH=/usr
          export NETCDF_C_LIBRARY=/usr/lib/x86_64-linux-gnu/libnetcdf.so
          export NETCDF_C_INCLUDE_DIR=/usr/include
          export PNETCDF_PATH=$HOME/pnetcdf
          ./create_test SMS_Vnuopc.f19_g17.A.ubuntu_gnu --machine ubuntu --no-build
          cd $HOME/scratch/SMS_Vnuopc.f19_g17*
          ./case.build
